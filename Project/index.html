<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>世界のイデオロギー分布マップ</title>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        /* 全体のスタイル設定 */
        body { margin: 0; padding: 0; font-family: sans-serif; }
        /* マップの表示エリア */
        #map { width: 100%; height: 100vh; }
        /* 凡例のスタイル */
        #legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 1;
            font-size: 0.9em;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        /* コントロールパネルのスタイル */
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .control-group select {
            padding: 8px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 180px; /* ドロップダウンの幅を固定 */
            font-size: 1em;
        }
        .control-group button {
            padding: 8px 12px;
            border-radius: 4px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            margin-left: 8px;
            font-size: 0.95em;
            transition: background-color 0.2s ease;
        }
        .control-group button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="legend">
        <h4>イデオロギー凡例</h4>
        <div id="legend-content"></div>
    </div>
    <div id="controls">
        <div class="control-group">
            <label for="ideology-select">イデオロギーで色分け:</label>
            <select id="ideology-select">
                <option value="all">全ての国を表示</option>
            </select>
            <button id="apply-ideology-filter">適用 & 移動</button>
        </div>

        <div class="control-group">
            <label for="country-select">国を選択して移動:</label>
            <select id="country-select">
                <option value="">国を選択してください</option>
            </select>
            <button id="go-to-country">移動</button>
        </div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js" crossorigin="anonymous"></script>
    <script>
        // --- データ定義 ---
        // 各国のイデオロギーデータ (ISO 3文字コードをキーとするダミーデータです。実際には独自の正確なデータに置き換えてください)
        const ideologyData = {
            'USA': { name_ja: 'アメリカ合衆国', ideology: '自由主義' },
            'CAN': { name_ja: 'カナダ', ideology: '自由主義' },
            'GBR': { name_ja: 'イギリス', ideology: '自由主義' },
            'FRA': { name_ja: 'フランス', ideology: '社会民主主義' },
            'DEU': { name_ja: 'ドイツ', ideology: '社会民主主義' },
            'JPN': { name_ja: '日本', ideology: '保守主義' },
            'CHN': { name_ja: '中華人民共和国', ideology: '社会主義（共産主義）' },
            'RUS': { name_ja: 'ロシア連邦', ideology: '権威主義' },
            'IND': { name_ja: 'インド', ideology: '多元主義' },
            'BRA': { name_ja: 'ブラジル', ideology: '社会民主民主主義' },
            'AUS': { name_ja: 'オーストラリア', ideology: '自由主義' },
            'ZAF': { name_ja: '南アフリカ', ideology: '社会民主主義' },
            'SAU': { name_ja: 'サウジアラビア', ideology: 'イスラム主義（君主制）' },
            'IRN': { name_ja: 'イラン', ideology: 'イスラム主義（共和制）' },
            'PRK': { name_ja: '朝鮮民主主義人民共和国', ideology: '全体主義' },
            'SWE': { name_ja: 'スウェーデン', ideology: '社会民主主義' },
            'NOR': { name_ja: 'ノルウェー', ideology: '社会民主主義' },
            'ESP': { name_ja: 'スペイン', ideology: '社会民主主義' },
            'ITA': { name_ja: 'イタリア', ideology: '社会民主主義' },
            'MEX': { name_ja: 'メキシコ', ideology: '自由主義' },
            'ARG': { name_ja: 'アルゼンチン', ideology: 'ポピュリズム' },
            'EGY': { name_ja: 'エジプト', ideology: 'イスラム主義（軍政）' },
            'NGA': { name_ja: 'ナイジェリア', ideology: '多元主義' },
            'VNM': { name_ja: 'ベトナム', ideology: '社会主義（共産主義）' },
            'CUB': { name_ja: 'キューバ', ideology: '社会主義（共産主義）' },
            'VEN': { name_ja: 'ベネズエラ', ideology: 'ポピュリズム' },
            'TUR': { name_ja: 'トルコ', ideology: '権威主義' },
            'KOR': { name_ja: '韓国', ideology: '自由主義' },
            'IDN': { name_ja: 'インドネシア', ideology: '多元主義' },
            'PAK': { name_ja: 'パキスタン', ideology: 'イスラム主義（共和制）' },
            'ISR': { name_ja: 'イスラエル', ideology: '保守主義' },
            'COL': { name_ja: 'コロンビア', ideology: '自由主義' },
            'PER': { name_ja: 'ペルー', ideology: 'ポピュリズム' },
            'GRL': { name_ja: 'グリーンランド', ideology: '自由主義' }, // グリーンランドのISOコードはGRL (デンマーク領)
            'AUT': { name_ja: 'オーストリア', ideology: '社会民主主義' },
            'BEL': { name_ja: 'ベルギー', ideology: '社会民主主義' },
            'CHE': { name_ja: 'スイス', ideology: '自由主義' },
            'DNK': { name_ja: 'デンマーク', ideology: '社会民主主義' },
            'FIN': { name_ja: 'フィンランド', ideology: '社会民主主義' },
            'IRL': { name_ja: 'アイルランド', ideology: '自由主義' },
            'NLD': { name_ja: 'オランダ', ideology: '自由主義' },
            'NZL': { name_ja: 'ニュージーランド', ideology: '自由主義' },
            'SGP': { name_ja: 'シンガポール', ideology: '権威主義' },
            'THA': { name_ja: 'タイ', ideology: '権威主義' },
            'PHL': { name_ja: 'フィリピン', ideology: '自由主義' },
            'MYS': { name_ja: 'マレーシア', ideology: '多元主義' },
            'CHL': { name_ja: 'チリ', ideology: '自由主義' },
            'CZE': { name_ja: 'チェコ', ideology: '社会民主主義' },
            'POL': { name_ja: 'ポーランド', ideology: '保守主義' },
            'UKR': { name_ja: 'ウクライナ', ideology: '多元主義' },
            // 世界の多くの国は「未分類」になります。必要に応じてさらに国とイデオロギーを追加してください。
        };

        // イデオロギーに対応する色の定義
        const ideologyColors = {
            '自由主義': '#FFD700', // 金色
            '社会民主主義': '#FF6347', // オレンジレッド
            '保守主義': '#1E90FF', // ドジャーブルー
            '社会主義（共産主義）': '#DC143C', // クリムゾン
            '権威主義': '#6A5ACD', // スレートブルー
            'イスラム主義（君主制）': '#228B22', // フォレストグリーン
            'イスラム主義（共和制）': '#006400', // ダークグリーン
            'イスラム主義（軍政）': '#3CB371', // ミディアムシ―グリーン
            '全体主義': '#4B0082', // インディゴ
            '多元主義': '#DAA520', // ゴールデンロッド
            'ポピュリズム': '#8A2BE2', // ブルーバイオレット
            '未分類': '#D3D3D3', // ライトグレー (イデオロギーが割り当てられていない国の色)
            // 必要に応じてさらに色とイデオロギーを追加
        };

        // --- マップの初期化 ---
        const map = new maplibregl.Map({
            container: 'map', // マップを表示するHTML要素のID
            style: {
                version: 8,
                sources: {
                    // Esri World Imagery の衛星画像タイルソース
                    'esri-imagery': {
                        type: 'raster',
                        tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                        tileSize: 256
                    },
                    // 国境線とポリゴンのGeoJSONソース
                    'countries': {
                        type: 'geojson',
                        // countries.geojson ファイルが `index.html` と同じディレクトリにあることを確認してください。
                        data: './countries.geojson'
                    }
                    // 'country-centroids' ソースは、Map.on('load') イベント内で動的に追加されます
                },
                layers: [
                    // 衛星画像レイヤー
                    {
                        id: 'esri-imagery-layer',
                        type: 'raster',
                        source: 'esri-imagery',
                        minzoom: 0,
                        maxzoom: 19
                    },
                    // 国の塗りつぶしポリゴンレイヤー
                    {
                        id: 'country-fills',
                        type: 'fill',
                        source: 'countries',
                        paint: {
                            // GeoJSONのISO 3文字コードのプロパティ名に基づいて色を決定します。
                            // 例: countries.geojson のプロパティが "iso_a3" なら 'iso_a3' を使用。
                            // もし異なる場合は、ここをGeoJSONの正確なプロパティ名に修正してください。
                            'fill-color': [
                                'match',
                                ['get', 'iso_a3'], // GeoJSON内のISO 3文字コードのプロパティ名
                                ...Object.entries(ideologyData).flatMap(([iso_a3, data]) => [iso_a3, ideologyColors[data.ideology] || ideologyColors['未分類']]),
                                ideologyColors['未分類'] // 一致しない場合のデフォルト色 (未分類)
                            ],
                            'fill-opacity': 0.7 // ポリゴンの透明度
                        }
                    },
                    // 国境線レイヤー
                    {
                        id: 'country-borders',
                        type: 'line',
                        source: 'countries',
                        paint: {
                            'line-color': '#FFFFFF', // 国境線の色
                            'line-width': 0.5 // 国境線の太さ
                        }
                    }
                    // 'country-circles' レイヤーは、Map.on('load') イベント内で動的に追加されます
                ]
            },
            center: [0, 20], // マップの初期中心座標 (経度, 緯度)
            zoom: 1 // マップの初期ズームレベル
        });

        // --- UI要素の取得 ---
        const ideologySelect = document.getElementById('ideology-select');
        const applyIdeologyFilterButton = document.getElementById('apply-ideology-filter');
        const countrySelect = document.getElementById('country-select');
        const goToCountryButton = document.getElementById('go-to-country');
        const legendContent = document.getElementById('legend-content');

        let allCountriesGeoJSON = null; // 全国のGeoJSONデータを保持する変数
        let countryCentroidsGeoJSON = { type: 'FeatureCollection', features: [] }; // 各国の重心点を保持するGeoJSON

        // --- Turf.js の読み込みとマップイベントリスナー登録 ---
        // Turf.js は地理空間演算 (例: バウンディングボックスの計算、重心の計算) のためのJavaScriptライブラリです。
        const turfScript = document.createElement('script');
        turfScript.src = 'https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js';
        document.head.appendChild(turfScript);

        // Turf.js が完全にロードされた後にマップのイベントリスナーを登録します。
        // これにより、`turf is not defined` のようなエラーを防ぎます。
        turfScript.onload = () => {
            // マップが完全にロードされたときに実行されるイベントリスナー
            map.on('load', () => {
                // --- GeoJSONファイルの読み込みと処理 ---
                fetch('./countries.geojson')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - Could not load countries.geojson. Make sure it's in the same directory.`);
                        }
                        return response.json();
                    })
                    .then(geojson => {
                        allCountriesGeoJSON = geojson; // 読み込んだGeoJSONデータを保存
                        countryCentroidsGeoJSON.features = []; // 重心点データを初期化

                        // 各国の重心点を計算し、ドロップダウンリストを生成
                        const countriesForSelect = [];
                        allCountriesGeoJSON.features.forEach(feature => {
                            // GeoJSONのプロパティ名に合わせてISO 3文字コードを取得
                            const iso_a3 = feature.properties.iso_a3 || feature.properties.properties_iso_a3 || feature.properties.ADM0_A3;
                            
                            let countryNameForDisplay = '不明な国';
                            if (ideologyData[iso_a3] && ideologyData[iso_a3].name_ja) {
                                countryNameForDisplay = ideologyData[iso_a3].name_ja;
                            } else {
                                // ideologyDataにない場合、GeoJSONのプロパティから英語名などを試みる
                                countryNameForDisplay = feature.properties.name || feature.properties.NAME || feature.properties.FORMAL_EN || '不明な国';
                            }


                            if (iso_a3 && feature.geometry) {
                                countriesForSelect.push({
                                    name_ja: countryNameForDisplay,
                                    iso_a3: iso_a3,
                                    geometry: feature.geometry
                                });

                                // 各国の重心を計算し、Pointフィーチャーとして追加
                                try {
                                    const centroid = turf.centroid(feature.geometry);
                                    centroid.properties = {
                                        iso_a3: iso_a3,
                                        name_ja: countryNameForDisplay
                                    };
                                    countryCentroidsGeoJSON.features.push(centroid);
                                } catch (e) {
                                    console.warn(`Could not calculate centroid for ${countryNameForDisplay} (${iso_a3}):`, e);
                                }
                            }
                        });

                        // 重心点GeoJSONソースをマップに追加
                        map.addSource('country-centroids', {
                            type: 'geojson',
                            data: countryCentroidsGeoJSON
                        });

                        // 重心点を示すCircleレイヤーを追加
                        map.addLayer({
                            id: 'country-circles',
                            type: 'circle',
                            source: 'country-centroids',
                            paint: {
                                'circle-color': '#000000', // 円の色 (黒)
                                'circle-radius': [ // ズームレベルに応じて円のサイズを変更
                                    'interpolate', ['linear'], ['zoom'],
                                    1, 1, // ズームレベル1で半径1px
                                    5, 4, // ズームレベル5で半径4px
                                    10, 8 // ズームレベル10で半径8px
                                ],
                                'circle-stroke-color': '#FFFFFF', // 円の枠線の色 (白)
                                'circle-stroke-width': 1, // 円の枠線の太さ
                                'circle-opacity': 0.8 // 円の透明度
                            }
                        });

                        // --- 国選択ドロップダウンの初期化 ---
                        countriesForSelect.sort((a, b) => a.name_ja.localeCompare(b.name_ja, 'ja')); // 日本語でソート
                        countriesForSelect.forEach(country => {
                            const option = document.createElement('option');
                            option.value = country.iso_a3;
                            option.textContent = country.name_ja; // 日本語名を表示
                            countrySelect.appendChild(option);
                        });

                        // --- 国をクリックした時のポップアップ表示 (ポリゴンと円の両方に対応) ---
                        map.on('click', ['country-fills', 'country-circles'], (e) => {
                            const countryProperties = e.features[0].properties;
                            const iso_a3 = countryProperties.iso_a3 || countryProperties.properties_iso_a3 || countryProperties.ADM0_A3;
                            
                            let countryNameDisplay = '不明な国';
                            let ideologyDisplay = '不明';

                            if (ideologyData[iso_a3]) {
                                countryNameDisplay = ideologyData[iso_a3].name_ja || countryProperties.name || countryProperties.NAME || '不明な国';
                                ideologyDisplay = ideologyData[iso_a3].ideology || '不明';
                            } else {
                                // ideologyDataにない場合、GeoJSONのプロパティから英語名などを試みる
                                countryNameDisplay = countryProperties.name || countryProperties.NAME || countryProperties.FORMAL_EN || '不明な国';
                            }

                            new maplibregl.Popup()
                                .setLngLat(e.lngLat)
                                .setHTML(`<strong>${countryNameDisplay}</strong><br>イデオロギー: ${ideologyDisplay}`)
                                .addTo(map);
                        });

                        // ホバー時のカーソル変更 (ポリゴンと円の両方に対応)
                        map.on('mouseenter', ['country-fills', 'country-circles'], () => {
                            map.getCanvas().style.cursor = 'pointer';
                        });
                        map.on('mouseleave', ['country-fills', 'country-circles'], () => {
                            map.getCanvas().style.cursor = '';
                        });

                    }) // fetch .then(geojson => ...) の終わり
                    .catch(error => {
                        console.error('Error fetching countries.geojson:', error);
                        alert('国境線データの読み込みに失敗しました。ファイルが正しい場所にあるか、開発者ツールでエラーを確認してください。');
                    });

                // --- 凡例を生成して表示 ---
                for (const [ideology, color] of Object.entries(ideologyColors)) {
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = `
                        <div class="legend-color" style="background-color: ${color};"></div>
                        <div>${ideology}</div>
                    `;
                    legendContent.appendChild(item);
                }

                // --- イデオロギー選択ドロップダウンの初期化 ---
                const uniqueIdeologies = new Set(Object.values(ideologyData).map(data => data.ideology));
                uniqueIdeologies.forEach(ideology => {
                    const option = document.createElement('option');
                    option.value = ideology;
                    option.textContent = ideology;
                    ideologySelect.appendChild(option);
                });

                // 「適用 & 移動」ボタンのクリックイベントリスナー
                applyIdeologyFilterButton.addEventListener('click', () => {
                    const selectedIdeology = ideologySelect.value;
                    let targetFeatures = [];

                    if (selectedIdeology === 'all') {
                        // 「全ての国を表示」が選択された場合、色分けをリセット
                        map.setPaintProperty('country-fills', 'fill-color', [
                            'match',
                            ['get', 'iso_a3'], // GeoJSONプロパティ名に合わせる
                            ...Object.entries(ideologyData).flatMap(([iso_a3, data]) => [iso_a3, ideologyColors[data.ideology] || ideologyColors['未分類']]),
                            ideologyColors['未分類']
                        ]);
                        map.setPaintProperty('country-fills', 'fill-opacity', 0.7);
                        // マップを全体にズームアウト
                        map.flyTo({ center: [0, 20], zoom: 1, duration: 1500 });
                    } else {
                        // 特定のイデオロギーが選択された場合、該当国を色分けし、他を薄くする
                        map.setPaintProperty('country-fills', 'fill-color', [
                            'match',
                            ['get', 'iso_a3'], // GeoJSONプロパティ名に合わせる
                            ...Object.entries(ideologyData).map(([iso_a3, data]) => {
                                if (data.ideology === selectedIdeology) {
                                    // 該当する国のフィーチャーを見つけてリストに追加
                                    const feature = allCountriesGeoJSON.features.find(f => (f.properties.iso_a3 || f.properties.properties_iso_a3 || f.properties.ADM0_A3) === iso_a3);
                                    if (feature) targetFeatures.push(feature);
                                    return [iso_a3, ideologyColors[data.ideology]]; // 該当イデオロギーの色
                                } else {
                                    return [iso_a3, '#D3D3D3']; // 他のイデオロギーは薄いグレー
                                }
                            }).flat(),
                            '#D3D3D3' // マッチしない場合のデフォルト色も薄いグレー
                        ]);
                        map.setPaintProperty('country-fills', 'fill-opacity', [
                            'match',
                            ['get', 'iso_a3'], // GeoJSONプロパティ名に合わせる
                            ...Object.entries(ideologyData).map(([iso_a3, data]) => {
                                if (data.ideology === selectedIdeology) {
                                    return [iso_a3, 0.7]; // 濃く表示
                                } else {
                                    return [iso_a3, 0.2]; // 薄く表示
                                }
                            }).flat(),
                            0.2 // デフォルトの薄さ
                        ]);

                        // 選択されたイデオロギーを持つ国々全体にマップを移動・ズーム
                        if (targetFeatures.length > 0) {
                            const featureCollection = turf.featureCollection(targetFeatures); // 対象フィーチャーをFeatureCollectionにまとめる
                            const bbox = turf.bbox(featureCollection); // 全体のバウンディングボックスを計算
                            map.fitBounds(bbox, {
                                padding: 50, // マップの端からの余白
                                duration: 1500, // アニメーションの時間（ミリ秒）
                                maxZoom: 5 // 最大ズームレベルを制限 (広範囲を表示するため)
                            });
                        } else {
                            // 選択されたイデオロギーに該当する国がない場合
                            alert('選択されたイデオロギーを持つ国の地理情報が見つかりませんでした。');
                        }
                    }
                });

                // 「移動」ボタンのクリックイベントリスナー
                goToCountryButton.addEventListener('click', () => {
                    const selectedIso_a3 = countrySelect.value;
                    if (selectedIso_a3 === '' || selectedIso_a3 === '---') {
                        alert('国を選択してください。');
                        return;
                    }

                    // 選択されたISOコードに対応するGeoJSONフィーチャーを検索
                    const selectedFeature = allCountriesGeoJSON.features.find(feature =>
                        (feature.properties.iso_a3 || feature.properties.properties_iso_a3 || feature.properties.ADM0_A3) === selectedIso_a3
                    );

                    // 選択された国の地理情報が見つかった場合、その国にマップを移動・ズーム
                    if (selectedFeature && selectedFeature.geometry) {
                        const bbox = turf.bbox(selectedFeature.geometry); // 国のバウンディングボックスを計算
                        map.fitBounds(bbox, {
                            padding: 50, // マップの端からの余白
                            duration: 1500, // アニメーションの時間（ミリ秒）
                            maxZoom: 7 // 個別の国にズームする際の最大ズームレベル
                        });
                    } else {
                        alert('選択された国の地理情報が見つかりませんでした。');
                    }
                });
            }); // map.on('load') の終わり
        }; // turfScript.onload の終わり
    </script>
</body>
</html>