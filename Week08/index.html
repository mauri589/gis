<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Hokkaido 1km Mesh Population Map</title>
		<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
		<link
			href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
			rel="stylesheet"
		/>
		<style>
			body {
				margin: 0;
				padding: 0;
			}
			#map {
				width: 100%;
				height: 100vh;
			}
		</style>
	</head>
	<body>
		<div id="map"></div>
		<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
		<script>
			const map = new maplibregl.Map({
				container: 'map',
				style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
				center: [142.50, 43.01],
				zoom: 8.5
			});

			map.on('load', () => {
				map.addSource('hokkaido', {
					type: 'geojson',
					data: 'hokkaido_population.geojson'
				});

				map.addLayer({
					id: 'population-layer',
					type: 'fill',
					source: 'hokkaido',
					paint: {
						'fill-color': [
							'interpolate',
							['linear'],
							['get', 'T001100001'],
							0,
							'#fac6e5',
							5000,
							'#fc89c3',
							10000,
							'#de3871',
							15000,
							'#9e0232',
							20000,
							'#4c0811'
						],
						'fill-opacity': 0.75,
						'fill-outline-color': '#0000ff'
					}
				});

				// Hover用の空のフィルター付きレイヤーを追加
				map.addLayer({
					id: 'population-layer-hover',
					type: 'line',
					source: 'hokkaido',
					paint: {
						'line-color': '#ffff00',
						'line-width': 3
					},
					filter: ['==', ['get', 'meshcode'], ''] // ←ここを修正
				});

				let hoveredMeshcode = null;

				map.on('mousemove', 'population-layer', (e) => {
					if (e.features.length > 0) {
						const meshcode = e.features[0].properties.meshcode; // ←ここを修正
						if (hoveredMeshcode !== meshcode) {
							hoveredMeshcode = meshcode;
							map.setFilter('population-layer-hover', ['==', ['get', 'meshcode'], hoveredMeshcode]); // ←ここを修正
						}
					}
				});

				map.on('mouseleave', 'population-layer', () => {
					hoveredId = meshcode = null;
					map.setFilter('population-layer-hover', ['==', 'id', '']);
				});
			});
		</script>
	</body>
</html>